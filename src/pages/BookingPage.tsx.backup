// pages/BookingPage.tsx
import { useState, useEffect } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { parks } from '../data/parks';
import { activities } from '../data/activities';
import { Calendar, Users, Clock, MapPin, CreditCard, CheckCircle, ChevronRight, ExternalLink } from 'lucide-react';

export function BookingPage() {
  const location = useLocation();
  const navigate = useNavigate();
  const preSelectedParkId = location.state?.parkId;
  const preSelectedActivityId = location.state?.activityId;

  const [step, setStep] = useState(1);
  const [selectedPark, setSelectedPark] = useState(preSelectedParkId || '');
  const [selectedActivity, setSelectedActivity] = useState(preSelectedActivityId || '');
  const [selectedDate, setSelectedDate] = useState('');
  const [selectedTime, setSelectedTime] = useState('');
  const [participants, setParticipants] = useState(2);
  const [formData, setFormData] = useState({
    firstName: '',
    lastName: '',
    email: '',
    phone: ''
  });
  const [isRedirecting, setIsRedirecting] = useState(false);
  const [quickleUrl, setQuickleUrl] = useState('');

  const timeSlots = [
    '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00'
  ];

  // Generate next 30 days for calendar
  const availableDates = Array.from({ length: 30 }, (_, i) => {
    const date = new Date();
    date.setDate(date.getDate() + i);
    return date.toISOString().split('T')[0];
  });

  const selectedParkData = parks.find(p => p.id === selectedPark);
  const selectedActivityData = activities.find(a => a.id === selectedActivity);

  const calculatePrice = () => {
    if (!selectedActivityData) return 0;
    return selectedActivityData.price * participants;
  };

  // Function to generate Quickle URL with all parameters
  const generateQuickleUrl = () => {
    if (!selectedParkData || !selectedActivityData || !selectedDate || !selectedTime) {
      return '';
    }

    const baseUrl = 'https://quickle.resengo.com/Booking/?';
    const params = new URLSearchParams({
      // Quickle required parameters
      'code': 'NOLIMIT', // Your Quickle business code
      'lang': 'fr',
      
      // Activity parameters
      'activity': encodeURIComponent(selectedActivityData.name),
      'activityId': selectedActivityData.quickleId || 'default', // You need to add quickleId to activities data
      
      // Park/location parameters
      'location': encodeURIComponent(selectedParkData.name),
      'locationId': selectedParkData.id,
      
      // Date and time
      'date': selectedDate,
      'time': selectedTime,
      
      // Participants
      'participants': participants.toString(),
      'adults': participants.toString(),
      
      // Customer info (if provided)
      ...(formData.firstName && { 'firstName': encodeURIComponent(formData.firstName) }),
      ...(formData.lastName && { 'lastName': encodeURIComponent(formData.lastName) }),
      ...(formData.email && { 'email': formData.email }),
      ...(formData.phone && { 'phone': formData.phone }),
      
      // Custom parameters for tracking
      'source': 'nolimit-website',
      'campaign': 'direct-booking'
    });

    return baseUrl + params.toString();
  };

  // Update Quickle URL when selections change
  useEffect(() => {
    if (selectedPark && selectedActivity && selectedDate && selectedTime) {
      const url = generateQuickleUrl();
      setQuickleUrl(url);
    }
  }, [selectedPark, selectedActivity, selectedDate, selectedTime, participants, formData]);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    
    if (step < 4) {
      setStep(step + 1);
      return;
    }

    // Step 4: Redirect to Quickle
    if (quickleUrl) {
      setIsRedirecting(true);
      
      // Optional: Save booking data locally
      const bookingData = {
        park: selectedParkData,
        activity: selectedActivityData,
        date: selectedDate,
        time: selectedTime,
        participants,
        customerInfo: formData,
        timestamp: new Date().toISOString()
      };
      
      localStorage.setItem('nolimit_booking_draft', JSON.stringify(bookingData));
      
      // Redirect to Quickle
      window.location.href = quickleUrl;
    }
  };

  const handleQuickleDirect = () => {
    if (quickleUrl) {
      setIsRedirecting(true);
      window.open(quickleUrl, '_blank');
    }
  };

  return (
    <div className="min-h-screen pt-28 pb-20 bg-gray-50">
      <div className="container mx-auto px-4">
        <div className="max-w-5xl mx-auto">
          {/* Progress Steps */}
          <div className="mb-12">
            <div className="flex items-center justify-between mb-4">
              {['Sélection', 'Date & Heure', 'Informations', 'Quickle'].map((label, index) => (
                <div key={label} className="flex items-center">
                  <div
                    className={`w-10 h-10 rounded-full flex items-center justify-center ${
                      step > index + 1
                        ? 'bg-green-600 text-white'
                        : step === index + 1
                        ? 'bg-orange-600 text-white'
                        : 'bg-gray-300 text-gray-600'
                    }`}
                  >
                    {step > index + 1 ? <CheckCircle className="size-5" /> : index + 1}
                  </div>
                  <span className={`ml-2 hidden md:block ${step === index + 1 ? 'text-gray-900' : 'text-gray-500'}`}>
                    {label}
                  </span>
                  {index < 3 && (
                    <ChevronRight className="size-5 text-gray-400 mx-2 hidden md:block" />
                  )}
                </div>
              ))}
            </div>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            {/* Main Form */}
            <div className="lg:col-span-2">
              <form onSubmit={handleSubmit} className="bg-white rounded-2xl p-8 shadow-md">
                {/* Step 1: Selection */}
                {step === 1 && (
                  <div className="space-y-6">
                    <h2 className="text-green-800 mb-6">Choisissez votre parc et activité</h2>
                    
                    <div>
                      <label className="block text-gray-700 mb-3">Parc</label>
                      <select
                        value={selectedPark}
                        onChange={(e) => setSelectedPark(e.target.value)}
                        required
                        className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500"
                      >
                        <option value="">Sélectionnez un parc</option>
                        {parks.map((park) => (
                          <option key={park.id} value={park.id}>
                            {park.name} - {park.location}
                          </option>
                        ))}
                      </select>
                    </div>

                    <div>
                      <label className="block text-gray-700 mb-3">Activité</label>
                      <select
                        value={selectedActivity}
                        onChange={(e) => setSelectedActivity(e.target.value)}
                        required
                        className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500"
                      >
                        <option value="">Sélectionnez une activité</option>
                        {activities.map((activity) => (
                          <option key={activity.id} value={activity.id}>
                            {activity.name} - {activity.price}€
                          </option>
                        ))}
                      </select>
                    </div>

                    <div>
                      <label className="block text-gray-700 mb-3">Nombre de participants</label>
                      <div className="flex items-center gap-4">
                        <button
                          type="button"
                          onClick={() => setParticipants(Math.max(1, participants - 1))}
                          className="w-12 h-12 bg-gray-100 hover:bg-gray-200 rounded-xl transition-colors"
                        >
                          -
                        </button>
                        <span className="text-2xl text-gray-900 min-w-[3rem] text-center">{participants}</span>
                        <button
                          type="button"
                          onClick={() => setParticipants(participants + 1)}
                          className="w-12 h-12 bg-gray-100 hover:bg-gray-200 rounded-xl transition-colors"
                        >
                          +
                        </button>
                      </div>
                    </div>
                  </div>
                )}

                {/* Step 2: Date & Time */}
                {step === 2 && (
                  <div className="space-y-6">
                    <h2 className="text-green-800 mb-6">Choisissez votre date et horaire</h2>
                    
                    <div>
                      <label className="block text-gray-700 mb-3">Date</label>
                      <div className="grid grid-cols-4 md:grid-cols-7 gap-2 max-h-96 overflow-y-auto">
                        {availableDates.map((date) => {
                          const dateObj = new Date(date);
                          const day = dateObj.getDate();
                          const month = dateObj.toLocaleDateString('fr-FR', { month: 'short' });
                          const weekday = dateObj.toLocaleDateString('fr-FR', { weekday: 'short' });
                          
                          return (
                            <button
                              key={date}
                              type="button"
                              onClick={() => setSelectedDate(date)}
                              className={`p-3 rounded-xl text-center transition-all ${
                                selectedDate === date
                                  ? 'bg-green-600 text-white shadow-lg'
                                  : 'bg-gray-50 hover:bg-gray-100 text-gray-700'
                              }`}
                            >
                              <div className="text-xs opacity-75">{weekday}</div>
                              <div className="text-xl">{day}</div>
                              <div className="text-xs opacity-75">{month}</div>
                            </button>
                          );
                        })}
                      </div>
                    </div>

                    <div>
                      <label className="block text-gray-700 mb-3">Horaire</label>
                      <div className="grid grid-cols-3 md:grid-cols-5 gap-3">
                        {timeSlots.map((time) => (
                          <button
                            key={time}
                            type="button"
                            onClick={() => setSelectedTime(time)}
                            className={`px-4 py-3 rounded-xl transition-all ${
                              selectedTime === time
                                ? 'bg-orange-600 text-white shadow-lg'
                                : 'bg-gray-50 hover:bg-gray-100 text-gray-700'
                            }`}
                          >
                            {time}
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>
                )}

                {/* Step 3: Information (optional - for pre-filling) */}
                {step === 3 && (
                  <div className="space-y-6">
                    <h2 className="text-green-800 mb-6">Vos informations (optionnel)</h2>
                    <p className="text-gray-600 mb-4">
                      Ces informations seront pré-remplies sur Quickle pour gagner du temps.
                    </p>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-gray-700 mb-2">Prénom</label>
                        <input
                          type="text"
                          value={formData.firstName}
                          onChange={(e) => setFormData({ ...formData, firstName: e.target.value })}
                          className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500"
                          placeholder="Jean"
                        />
                      </div>
                      <div>
                        <label className="block text-gray-700 mb-2">Nom</label>
                        <input
                          type="text"
                          value={formData.lastName}
                          onChange={(e) => setFormData({ ...formData, lastName: e.target.value })}
                          className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500"
                          placeholder="Dupont"
                        />
                      </div>
                    </div>

                    <div>
                      <label className="block text-gray-700 mb-2">Email</label>
                      <input
                        type="email"
                        value={formData.email}
                        onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                        className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500"
                        placeholder="jean.dupont@email.com"
                      />
                    </div>

                    <div>
                      <label className="block text-gray-700 mb-2">Téléphone</label>
                      <input
                        type="tel"
                        value={formData.phone}
                        onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                        className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500"
                        placeholder="06 12 34 56 78"
                      />
                    </div>
                  </div>
                )}

                {/* Step 4: Quickle Redirect */}
                {step === 4 && (
                  <div className="space-y-6">
                    <h2 className="text-green-800 mb-6">Finaliser sur Quickle</h2>
                    
                    <div className="bg-gradient-to-br from-green-50 to-blue-50 border-2 border-green-200 rounded-2xl p-6 mb-6">
                      <div className="flex items-center gap-3 mb-4">
                        <div className="w-12 h-12 bg-green-600 rounded-xl flex items-center justify-center">
                          <ExternalLink className="size-6 text-white" />
                        </div>
                        <div>
                          <h3 className="text-green-800 text-xl font-bold">Redirection vers Quickle</h3>
                          <p className="text-green-700">
                            Vous allez être redirigé vers notre plateforme de réservation sécurisée.
                          </p>
                        </div>
                      </div>
                      
                      <div className="space-y-3 text-sm text-gray-700">
                        <div className="flex items-center gap-2">
                          <CheckCircle className="size-4 text-green-600" />
                          <span>Paiement 100% sécurisé</span>
                        </div>
                        <div className="flex items-center gap-2">
                          <CheckCircle className="size-4 text-green-600" />
                          <span>Confirmation instantanée</span>
                        </div>
                        <div className="flex items-center gap-2">
                          <CheckCircle className="size-4 text-green-600" />
                          <span>E-billet envoyé par email</span>
                        </div>
                        <div className="flex items-center gap-2">
                          <CheckCircle className="size-4 text-green-600" />
                          <span>Annulation gratuite jusqu'à 48h avant</span>
                        </div>
                      </div>
                    </div>

                    {isRedirecting ? (
                      <div className="text-center py-8">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto mb-4"></div>
                        <p className="text-gray-600">Redirection vers Quickle...</p>
                      </div>
                    ) : (
                      <div className="space-y-4">
                        <button
                          type="button"
                          onClick={handleSubmit}
                          className="w-full py-4 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl hover:from-green-700 hover:to-green-800 transition-all hover:shadow-lg font-bold text-lg flex items-center justify-center gap-3"
                        >
                          <ExternalLink className="size-5" />
                          Finaliser la réservation sur Quickle
                        </button>
                        
                        <button
                          type="button"
                          onClick={handleQuickleDirect}
                          className="w-full py-3 bg-white border-2 border-green-600 text-green-600 rounded-xl hover:bg-green-50 transition-colors"
                        >
                          Ouvrir Quickle dans un nouvel onglet
                        </button>
                      </div>
                    )}
                  </div>
                )}

                {/* Navigation Buttons */}
                {step < 4 && (
                  <div className="flex gap-4 mt-8">
                    {step > 1 && (
                      <button
                        type="button"
                        onClick={() => setStep(step - 1)}
                        className="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-colors"
                      >
                        Retour
                      </button>
                    )}
                    <button
                      type="submit"
                      className={`flex-1 px-6 py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl hover:from-orange-600 hover:to-orange-700 transition-all hover:shadow-lg ${
                        (step === 1 && (!selectedPark || !selectedActivity)) ||
                        (step === 2 && (!selectedDate || !selectedTime))
                          ? 'opacity-50 cursor-not-allowed'
                          : ''
                      }`}
                      disabled={
                        (step === 1 && (!selectedPark || !selectedActivity)) ||
                        (step === 2 && (!selectedDate || !selectedTime))
                      }
                    >
                      Continuer
                    </button>
                  </div>
                )}
              </form>
            </div>

            {/* Summary Sidebar */}
            <div className="lg:col-span-1">
              <div className="sticky top-28 bg-white rounded-2xl p-6 shadow-lg">
                <h3 className="text-gray-900 mb-6">Votre sélection</h3>
                
                <div className="space-y-4 mb-6">
                  {selectedParkData && (
                    <div className="flex items-start gap-3">
                      <MapPin className="size-5 text-green-600 mt-0.5" />
                      <div>
                        <div className="text-sm text-gray-600 mb-1">Parc</div>
                        <div className="text-gray-900 font-medium">{selectedParkData.name}</div>
                      </div>
                    </div>
                  )}
                  
                  {selectedActivityData && (
                    <div className="flex items-start gap-3">
                      <Clock className="size-5 text-orange-600 mt-0.5" />
                      <div>
                        <div className="text-sm text-gray-600 mb-1">Activité</div>
                        <div className="text-gray-900 font-medium">{selectedActivityData.name}</div>
                      </div>
                    </div>
                  )}
                  
                  {selectedDate && (
                    <div className="flex items-start gap-3">
                      <Calendar className="size-5 text-green-600 mt-0.5" />
                      <div>
                        <div className="text-sm text-gray-600 mb-1">Date</div>
                        <div className="text-gray-900">
                          {new Date(selectedDate).toLocaleDateString('fr-FR', {
                            weekday: 'long',
                            day: 'numeric',
                            month: 'long'
                          })}
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {selectedTime && (
                    <div>
                      <div className="text-sm text-gray-600 mb-1">Horaire</div>
                      <div className="text-gray-900 font-medium">{selectedTime}</div>
                    </div>
                  )}
                  
                  <div className="flex items-start gap-3">
                    <Users className="size-5 text-green-600 mt-0.5" />
                    <div>
                      <div className="text-sm text-gray-600 mb-1">Participants</div>
                      <div className="text-gray-900 font-medium">
                        {participants} personne{participants > 1 ? 's' : ''}
                      </div>
                    </div>
                  </div>
                </div>
                
                <div className="border-t border-gray-200 pt-4">
                  <div className="flex justify-between items-center mb-2">
                    <span className="text-gray-600">Prix total estimé</span>
                    <span className="text-gray-900 font-bold">{calculatePrice()}€</span>
                  </div>
                  
                  <div className="bg-green-50 rounded-lg p-3 text-sm text-green-700 mt-4">
                    <div className="flex items-center gap-2 mb-1">
                      <CreditCard className="size-4" />
                      <span className="font-medium">Finalisation sur Quickle</span>
                    </div>
                    <div className="text-xs text-green-600">
                      Le paiement et la confirmation se feront sur la plateforme Quickle
                    </div>
                  </div>
                </div>

                {/* Quickle Preview Link (hidden on mobile) */}
                {quickleUrl && step < 4 && (
                  <div className="mt-6 pt-6 border-t border-gray-200 hidden lg:block">
                    <p className="text-xs text-gray-500 mb-2">Lien Quickle généré :</p>
                    <div className="text-xs text-gray-600 break-all bg-gray-50 p-2 rounded">
                      {quickleUrl.substring(0, 60)}...
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* Quickle Integration Info */}
          <div className="mt-12 bg-blue-50 rounded-2xl p-6 border border-blue-200">
            <div className="flex items-start gap-4">
              <div className="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
                <ExternalLink className="size-5 text-white" />
              </div>
              <div>
                <h3 className="text-blue-800 font-bold mb-2">À propos de Quickle</h3>
                <p className="text-blue-700 mb-2">
                  Quickle est notre partenaire de réservation en ligne. Cette plateforme sécurisée 
                  gère les créneaux disponibles, les paiements et les confirmations en temps réel.
                </p>
                <p className="text-blue-600 text-sm">
                  Vous serez redirigé vers quickle.resengo.com pour finaliser votre réservation.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}